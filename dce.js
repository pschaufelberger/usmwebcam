/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Camera Enhancer JS Edition
 * @website https://www.dynamsoft.com
 * @copyright Copyright 2022, Dynamsoft Corporation
 * @author Dynamsoft
 * @version 2.1.0 (js 20220119)
 * @fileoverview Dynamsoft JavaScript Library for Camera Enhancer
 * More info on DCE JS: https://www.dynamsoft.com/camera-enhancer/docs/programming/javascript/?ver=latest
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).Dynamsoft=e.Dynamsoft||{},e.Dynamsoft.DCE={}))}(this,(function(e){"use strict";function t(e,t,i,o){return new(i||(i=Promise))((function(r,s){function n(e){try{h(o.next(e))}catch(e){s(e)}}function a(e){try{h(o.throw(e))}catch(e){s(e)}}function h(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}h((o=o.apply(e,t||[])).next())}))}const i=!!("object"==typeof global&&global.process&&global.process.release&&global.process.release.name&&"undefined"==typeof HTMLCanvasElement),o=!i&&"undefined"==typeof self;class r{constructor(){this._maxCvsSideLength="iPhone"==r.browserInfo.OS||"Android"==r.browserInfo.OS?2048:4096,this._bWebGLSupported=!0,this._singleFrameMode=!(navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),this._cvsSingleFrameMode=null,this._imgWidth=0,this._imgHeight=0,this._singleFrameModeIpt=null,this._clickIptSingleFrameMode=()=>{if(this.singleFrameMode){if(!this._singleFrameModeIpt){const e=document.createElement("input");this._singleFrameModeIpt=e,e.setAttribute("type","file"),e.setAttribute("accept",".jpg,.jpeg,.icon,.gif,.svg,.webp,.png,.bmp"),e.setAttribute("capture",""),e.addEventListener("change",(()=>t(this,void 0,void 0,(function*(){const i=e.files[0];e.value="";const o=yield(e=>t(this,void 0,void 0,(function*(){let t=null,i=null;if("undefined"!=typeof createImageBitmap)try{if(t=yield createImageBitmap(e),t)return t}catch(e){}var o;return t||(i=yield(o=e,new Promise(((e,t)=>{let i=URL.createObjectURL(o),r=new Image;r.dbrObjUrl=i,r.src=i,r.onload=()=>{e(r)},r.onerror=e=>{t(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}})))),i})))(i),r=o instanceof HTMLImageElement?o.naturalWidth:o.width,s=o instanceof HTMLImageElement?o.naturalHeight:o.height;this._imgWidth=r,this._imgHeight=s;(e=>{if(!this._cvsSingleFrameMode){if(this._cvsSingleFrameMode=document.createElement("canvas"),this._cvsSingleFrameMode.className="cvs-single-frame-mode",this._cvsSingleFrameMode.addEventListener("click",this._clickIptSingleFrameMode),this._cvsSingleFrameMode.style.cursor="pointer",this._cvsSingleFrameMode.setAttribute("title","Take a photo"),!this._video)throw new Error("'video' is null.");this._video.after(this._cvsSingleFrameMode)}const t=this._cvsSingleFrameMode;t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit="contain",t.width==r&&t.height==s||(t.width=r,t.height=s);let i=t.getContext("2d");i.clearRect(0,0,t.width,t.height),i.drawImage(e,0,0)})(o),this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);const n=(e=>{const t=Date.now();let i,o,n,a,h,l=r,d=s;const c=this._scanRegion;let g={regionLeft:0,regionTop:0,regionRight:l,regionBottom:d,regionMeasuredByPercentage:!1};c?(c.regionMeasuredByPercentage?(g.regionLeft=c.regionLeft*l/100,g.regionTop=c.regionTop*d/100,g.regionRight=c.regionRight*l/100,g.regionBottom=c.regionBottom*d/100):(g.regionLeft=c.regionLeft,g.regionTop=c.regionTop,g.regionRight=c.regionRight,g.regionBottom=c.regionBottom),i=g.regionLeft,o=g.regionTop,l=Math.round(g.regionRight-g.regionLeft),d=Math.round(g.regionBottom-g.regionTop),h=!0):(i=0,o=0,h=!1);const v=Math.max(l,d);if(v>this._maxCvsSideLength&&this._maxCvsSideLength>0){const e=this._maxCvsSideLength/v;l>d?(n=this._maxCvsSideLength,a=Math.round(d*e)):(n=Math.round(l*e),a=this._maxCvsSideLength)}else n=l,a=d;const _=document.createElement("canvas");_.width=n,_.height=a;_.getContext("2d").drawImage(e,i,o,l,d,0,0,n,a);const u=Date.now();return{canvas:_,region:c?JSON.parse(JSON.stringify(c)):null,sx:i,sy:o,width:l,height:d,timeSpent:u-t,timeStamp:u,isCropped:h}})(o),a=this.mapCameraEvents.get("singleFrameAcquired");for(let e of a)try{e({data:new File([i],"selectedFile"),canvas:n.canvas,region:JSON.parse(JSON.stringify(n.region)),sx:n.sx,sy:n.sy,width:n.width,height:n.height,timeSpent:n.timeSpent,timeStamp:n.timeStamp,isCropped:n.isCropped})}catch(e){console.error(e)}})))),e.style.position="fixed",e.style.left="-1px",e.style.top="-1px",e.style.width="1px",e.style.height="1px",e.style.backgroundColor="transparent",e.style.color="transparent",this._video.parentElement.appendChild(e)}this._singleFrameModeIpt.click()}},this.styleEls=[],this.bSaveOriCanvas=!0,this.maxVideoCvsLength=3,this.videoCvses=[],this.videoGlCvs=null,this.videoGl=null,this.glImgData=null,this.webglTexture=null,this.webglProgramInfo=null,this.webglBuffers=null,this._onCameraSelChange=()=>t(this,void 0,void 0,(function*(){yield this.selectCamera(this._selCam.value),this._bOpen||this.stop()})),this._onResolutionSelChange=()=>t(this,void 0,void 0,(function*(){let e,t;if(this._selRsl&&-1!=this._selRsl.selectedIndex){let i=this._selRsl.options[this._selRsl.selectedIndex];e=i.getAttribute("data-width"),t=i.getAttribute("data-height")}yield this.setResolution(e,t),this._bOpen||this.stop()})),this._onCloseBtnClick=()=>{this.close(!0)},this._bOpen=!1,this.videoSrc=null,this.videoSettings={video:{width:{ideal:1280},height:{ideal:720},facingMode:{ideal:"environment"}}},this.iPlayRound=0,this.promisePlay=null,this._ifSaveLastUsedCamera=!1,this.ifSkipCameraInspection=!1,this._allCameras=[],this._currentCamera=null,this._videoTrack=null,this._lastDeviceId=void 0,this._vc_bPlayingVideoBeforeHide=!1,this._ev_documentHideEvent=()=>{"visible"===document.visibilityState?this._vc_bPlayingVideoBeforeHide&&("Firefox"==r.browserInfo.browser?this.play():this._video.play(),this._vc_bPlayingVideoBeforeHide=!1):this._video&&!this._video.paused&&(this._vc_bPlayingVideoBeforeHide=!0,this._video.pause())},this._video=null,this._cvsScanRegion=null,this._divScanArea=null,this._divScanLight=null,this._bgLoading=null,this._selCam=null,this._bgCamera=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this.regionMaskFillStyle="rgba(0,0,0,0.5)",this.regionMaskStrokeStyle="rgb(254,142,20)",this.regionMaskLineWidth=2,this._bShowScanRegionMask=!0,this._bShowScanRegionLaser=!1,this._scanRegion=null,this._arrScanRegionOverlays=[],this._cvsViewDecorator=null,this._decoratorType=[],this._decoratorArea=null,this._viewDecoratorInfo={rectangle:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},focus:{lineWidth:4,strokeStyle:"rgb(254,142,20)",fillStyle:"transparent",maskFillStyle:"transparent"},crossline:{lineWidth:2,strokeStyle:"rgb(254,142,20)"},crosshair:{lineWidth:4,strokeStyle:"rgb(254,142,20)"}},this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0,this._loopInterval=0,this._maxNumberOfFramesInBuffer=1,this._frameQueue=[],this._bFetchingLoopStarted=!1,this._bStoppedByPause=!1,this.refreshInterval=0,this._updateCanvasTimeout=500,this._onWindowResize=()=>{this._resizeTimeoutId&&clearTimeout(this._resizeTimeoutId),this._resizeTimeoutId=setTimeout((()=>{this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}),this._updateCanvasTimeout)},this.bDestroyed=!1,this.mapCameraEvents=new Map([["cameraOpen",[]],["cameraClose",[]],["cameraChange",[]],["resolutionChange",[]],["played",[]],["singleFrameAcquired",[]]])}static getVersion(){return this._version}static detectEnvironment(){return t(this,void 0,void 0,(function*(){let e={wasm:"undefined"!=typeof WebAssembly&&("undefined"==typeof navigator||!(/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&/\(.+\s11_2_([2-6]).*\)/.test(navigator.userAgent))),worker:!!(i?process.version>="v12":"undefined"!=typeof Worker),getUserMedia:!("undefined"==typeof navigator||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia),camera:!1,browser:this.browserInfo.browser,version:this.browserInfo.version,OS:this.browserInfo.OS};if(e.getUserMedia)try{(yield navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>{e.stop()})),e.camera=!0}catch(e){}return e}))}static get engineResourcePath(){return this._engineResourcePath}static set engineResourcePath(e){if(this._hasEngineResourceLoaded)throw new Error("`engineResourcePath` is not allowed to change after `createInstance` is called.");if(null==e&&(e="./"),i||o)r._engineResourcePath=e;else{let t=document.createElement("a");t.href=e,r._engineResourcePath=t.href}this._engineResourcePath.endsWith("/")||(r._engineResourcePath+="/")}static isStorageAvailable(e){let t;try{t=window[e];const i="__storage_test__";return t.setItem(i,i),t.removeItem(i),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&t&&0!==t.length}}static get defaultUIElementURL(){var e;return null===(e=r._defaultUIElementURL)||void 0===e?void 0:e.replace("@engineResourcePath/",r.engineResourcePath)}static set defaultUIElementURL(e){r._defaultUIElementURL=e}getUIElement(){return this.UIElement}setUIElement(e){return t(this,void 0,void 0,(function*(){if(this._bOpen)throw new Error("It is not allowed to change the UIElement when the camera is open.");if("string"==typeof e||e instanceof String){if(!e.trim().startsWith("<")){let t=yield fetch(e);if(!t.ok)throw Error("setUIElement(elementOrUrl): Network Error: "+t.statusText);e=yield t.text()}if(!e.trim().startsWith("<"))throw Error("setUIElement(elementOrUrl): Can't get valid HTMLElement.");let t=document.createElement("div");t.innerHTML=e;for(let e=0;e<t.childElementCount;++e){let i=t.children[e];i instanceof HTMLStyleElement&&(this.styleEls.push(i),document.head.append(i))}(e=1==t.childElementCount?t.children[0]:t).remove()}this.UIElement=e}))}get singleFrameMode(){return this._singleFrameMode}set singleFrameMode(e){if(this._bOpen)throw new Error("It is not allowed to change `singleFrameMode` when the camera is open.");this._singleFrameMode=e}get ifSaveOriginalImageInACanvas(){return this.bSaveOriCanvas}set ifSaveOriginalImageInACanvas(e){this.bSaveOriCanvas=e}_bindUI(){if(!this.UIElement)throw new Error("Need to define `UIElement` before opening.");let e=[this.UIElement];for(let t=0;t<e.length;++t)for(let i of e[t].children)e.push(i);let t=null;for(let i of e)!this._video&&i.classList.contains("dce-video")?(this._video=i,this._video.setAttribute("playsinline","true")):!this._divScanArea&&i.classList.contains("dce-scanarea")?this._divScanArea=i:!this._divScanLight&&i.classList.contains("dce-scanlight")?this._divScanLight=i:!this._bgLoading&&i.classList.contains("dce-bg-loading")?this._bgLoading=i:!this._bgCamera&&i.classList.contains("dce-bg-camera")?this._bgCamera=i:!this._selCam&&i.classList.contains("dce-sel-camera")?this._selCam=i:!this._selRsl&&i.classList.contains("dce-sel-resolution")?(this._selRsl=i,this.videoSrc||this.singleFrameMode||this._selRsl.options.length||(this._selRsl.innerHTML=[this._optGotRsl?"":'<option class="dce-opt-gotResolution" value="got"></option>','<option data-width="1920" data-height="1080">1920x1080</option>','<option data-width="1280" data-height="720">1280x720</option>','<option data-width="640" data-height="480">640x480</option>'].join(""),this._optGotRsl=this._optGotRsl||this._selRsl.options[0])):!this._optGotRsl&&i.classList.contains("dce-opt-gotResolution")?this._optGotRsl=i:!this._btnClose&&i.classList.contains("dce-btn-close")?this._btnClose=i:!this._video&&i.classList.contains("dce-existingVideo")?(this._video=i,this._video.setAttribute("playsinline","true")):!t&&i.tagName&&"video"==i.tagName.toLowerCase()&&(t=i);if(!this._video&&t&&(this._video=t),!this._video)throw this._unbindUI(),Error("Can not find HTMLVideoElement with class `dce-video`");this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._divScanArea&&(this._divScanArea.addEventListener("click",this._clickIptSingleFrameMode),this._divScanArea.style.cursor="pointer",this._divScanArea.setAttribute("title","Take a photo"))):this._bgLoading&&(this._bgLoading.style.display=""),this.singleFrameMode?(this._video&&(this._video.addEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="pointer",this._video.setAttribute("title","Take a photo")),this._bgCamera&&(this._bgCamera.style.display="")):this._bgLoading&&(this._bgLoading.style.display=""),this._selCam&&this._selCam.addEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.addEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.addEventListener("click",this._onCloseBtnClick),document.addEventListener("visibilitychange",this._ev_documentHideEvent),window.addEventListener("resize",this._onWindowResize)}_unbindUI(){this.singleFrameMode?(this._video&&(this._video.removeEventListener("click",this._clickIptSingleFrameMode),this._video.style.cursor="",this._video.removeAttribute("title")),this._divScanArea&&(this._divScanArea.removeEventListener("click",this._clickIptSingleFrameMode),this._divScanArea.style.cursor="",this._divScanArea.removeAttribute("title")),this._bgCamera&&(this._bgCamera.style.display="none")):this._bgLoading&&(this._bgLoading.style.display="none"),this._selCam&&this._selCam.removeEventListener("change",this._onCameraSelChange),this._selRsl&&this._selRsl.removeEventListener("change",this._onResolutionSelChange),this._btnClose&&this._btnClose.removeEventListener("click",this._onCloseBtnClick),this.hideScanRegionLaser(),this.hideViewDecorator(),this._cvsViewDecorator&&(this._cvsViewDecorator.removeEventListener("click",this._clickIptSingleFrameMode),this._cvsViewDecorator.style.cursor="",this._cvsViewDecorator.removeAttribute("title")),this.hideScanRegionOverlays();for(let e of this._arrScanRegionOverlays)e&&(e.removeEventListener("click",this._clickIptSingleFrameMode),e.style.cursor="",e.removeAttribute("title"));this._video.onloadedmetadata=null,this._video=null,this._selCam=null,this._selRsl=null,this._optGotRsl=null,this._btnClose=null,this._divScanArea=null,this._divScanLight=null,this._cvsScanRegion&&(this._cvsScanRegion.remove(),this._cvsScanRegion=null),this._singleFrameModeIpt&&(this._singleFrameModeIpt.remove(),this._singleFrameModeIpt=null),this._cvsSingleFrameMode&&(this._cvsSingleFrameMode.remove(),this._cvsSingleFrameMode=null),document.removeEventListener("visibilitychange",this._ev_documentHideEvent),window.removeEventListener("resize",this._onWindowResize)}set bOpen(e){if(this._bOpen=e,e){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);this._bShowScanRegionMask?this.showScanRegionMask():this.hideScanRegionMask(),this._bShowScanRegionLaser?this.showScanRegionLaser():this.hideScanRegionLaser(),this.showViewDecorator(),this._cvsViewDecorator&&(this._cvsViewDecorator.addEventListener("click",this._clickIptSingleFrameMode),this._cvsViewDecorator.style.cursor="pointer",this._cvsViewDecorator.setAttribute("title","Take a photo")),this.showScanRegionOverlays();for(let e of this._arrScanRegionOverlays)e&&(e.addEventListener("click",this._clickIptSingleFrameMode),e.style.cursor="pointer",e.setAttribute("title","Take a photo"))}}_assertOpen(){if(!this._bOpen)throw Error("The camera is not open.")}set ifSaveLastUsedCamera(e){e?r.isStorageAvailable("localStorage")?this._ifSaveLastUsedCamera=!0:(this._ifSaveLastUsedCamera=!1,console.warn("Local storage is unavailable")):this._ifSaveLastUsedCamera=!1}get ifSaveLastUsedCamera(){return this._ifSaveLastUsedCamera}get video(){return this._video}setVideoFit(e){if(this._assertOpen(),!this._video)return;if(e=e.toLowerCase(),!["contain","cover"].includes(e))throw new Error(`It is not allowed to set '${e}'.`);if(this._video.style.objectFit=e,!this.singleFrameMode){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}}getVideoFit(){if(this._video)return window.getComputedStyle(this._video).objectFit}set ifShowScanRegionMask(e){this._bShowScanRegionMask=e,e?this.showScanRegionMask():this.hideScanRegionMask()}get ifShowScanRegionMask(){return this._bShowScanRegionMask}showScanRegionMask(){this._cvsScanRegion&&"none"==this._cvsScanRegion.style.display&&(this._cvsScanRegion.style.display="")}hideScanRegionMask(){this._cvsScanRegion&&(this._cvsScanRegion.style.display="none")}set ifShowScanRegionLaser(e){this._bShowScanRegionLaser=e,e?this.showScanRegionLaser():this.hideScanRegionLaser()}get ifShowScanRegionLaser(){return this._bShowScanRegionLaser}showScanRegionLaser(){this._divScanLight&&"none"==this._divScanLight.style.display&&(this._divScanLight.style.display="")}hideScanRegionLaser(){this._divScanLight&&(this._divScanLight.style.display="none")}_checkValidRegion(e){return null===e||!!e&&(!!(e.hasOwnProperty("regionLeft")&&e.hasOwnProperty("regionTop")&&e.hasOwnProperty("regionRight")&&e.hasOwnProperty("regionBottom")&&e.hasOwnProperty("regionMeasuredByPercentage"))&&(!(e.regionLeft<0||e.regionTop<0||e.regionRight<0||e.regionBottom<0)&&(!e.regionMeasuredByPercentage||!(e.regionLeft>100||e.regionTop>100||e.regionRight>100||e.regionBottom>100))))}set scanRegion(e){if(!this._checkValidRegion(e))throw new Error("The region is invalid.");this._scanRegion=JSON.parse(JSON.stringify(e)),this._updateScanRegionCanvas(),this._updateScanAreaDiv();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e)}setScanRegion(e){this.scanRegion=e}getScanRegion(){return JSON.parse(JSON.stringify(this._scanRegion))}addScanRegionOverlayCanvas(){this._assertOpen();const e=document.createElement("canvas");if(e.className="cvs-scan-region-overlay-"+this._arrScanRegionOverlays.length,this.singleFrameMode&&(e.addEventListener("click",this._clickIptSingleFrameMode),e.style.cursor="pointer",e.setAttribute("title","Take a photo")),this._updateScanRegionOverlay(e),this._arrScanRegionOverlays.length>0){const t=this._arrScanRegionOverlays.length;this._arrScanRegionOverlays[t-1].after(e)}else if(this._cvsScanRegion)this._cvsScanRegion.before(e);else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(e);else{if(!this._video)throw new Error("'video' is null.");this._video.after(e)}return this._arrScanRegionOverlays.push(e),e}_updateScanRegionOverlay(e){if(!e)return;let t,i,o;if(this.singleFrameMode)t=this._imgWidth,i=this._imgHeight,o="contain";else{if(!this._video)return;t=this._video.videoWidth,i=this._video.videoHeight,o=this.getVideoFit()}if(t<=0||i<=0)return e.width=0,void(e.height=0);const r=this._getRegionInPixels(t,i,this._scanRegion),s=r.regionRight-r.regionLeft,n=r.regionBottom-r.regionTop;e.width==s&&e.height==n||(e.width=s,e.height=n);const a=window.getComputedStyle(this._video),h=parseFloat(a.width),l=parseFloat(a.height),d=h/l,c=t/i;let g,v,_,u,m=1;if("contain"===o)d<c?(m=h/t,g=0,v=(l-i*m)/2):(m=l/i,g=(h-t*m)/2,v=0),g+=r.regionLeft*m,v+=r.regionTop*m,_=(r.regionRight-r.regionLeft)*m,u=(r.regionBottom-r.regionTop)*m;else if("cover"===o)if(d<c){m=l/i,g=r.regionLeft*m-(t*m-h)/2,g=Math.max(g,0),g=Math.min(g,parseFloat(a.width)),v=r.regionTop*m;let e=r.regionRight*m-(t*m-h)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(a.width)),_=e-g,u=(r.regionBottom-r.regionTop)*m}else{m=h/t,g=r.regionLeft*m,v=r.regionTop*m-(i*m-l)/2,v=Math.max(v,0),v=Math.min(v,parseFloat(a.height));let e=r.regionBottom*m-(i*m-l)/2;e=Math.max(e,0),e=Math.min(e,parseFloat(a.height)),_=(r.regionRight-r.regionLeft)*m,u=e-v}else g=0,v=0,_=0,u=0;e.style.position="absolute",e.style.left=g+"px",e.style.top=v+"px",e.style.width=_+"px",e.style.height=u+"px"}showScanRegionOverlays(){for(let e of this._arrScanRegionOverlays)e&&"none"==e.style.display&&(e.style.display="")}hideScanRegionOverlays(){for(let e of this._arrScanRegionOverlays)e&&(e.style.display="none")}setViewDecorator(e,t){if(!e)return void(this._cvsViewDecorator&&(this._cvsViewDecorator.remove(),this._cvsViewDecorator=null));this._assertOpen();let i=[];if("string"==typeof e?i.push(e):Array.isArray(e)&&(i=JSON.parse(JSON.stringify(e))),!this._cvsViewDecorator)if(this._cvsViewDecorator=document.createElement("canvas"),this._cvsViewDecorator.className="cvs-view-decorator",this.singleFrameMode&&(this._cvsViewDecorator.addEventListener("click",this._clickIptSingleFrameMode),this._cvsViewDecorator.style.cursor="pointer",this._cvsViewDecorator.setAttribute("title","Take a photo")),this._divScanArea)this._divScanArea.after(this._cvsViewDecorator);else if(this._cvsScanRegion)this._cvsScanRegion.after(this._cvsViewDecorator);else if(this._arrScanRegionOverlays&&0!=this._arrScanRegionOverlays.length){const e=this._arrScanRegionOverlays.length;this._arrScanRegionOverlays[e-1].after(this._cvsViewDecorator)}else if(this._cvsSingleFrameMode)this._cvsSingleFrameMode.after(this._cvsViewDecorator);else{if(!this._video)throw new Error("'video' is null.");this._video.after(this._cvsViewDecorator)}this._decoratorArea=JSON.parse(JSON.stringify(t)),this._decoratorType.length=0;const o=["rectangle","focus"],r=["crossline","crosshair"];let s=!1,n=!1;for(let e of i)e=e.toLowerCase(),o.includes(e)&&!s&&(s=!0,this._decoratorType.push(e)),r.includes(e)&&!n&&(n=!0,!this._decoratorType.includes(e)&&this._decoratorType.push(e));this._updateViewDecorator()}getViewDecorator(){return{type:JSON.parse(JSON.stringify(this._decoratorType)),area:JSON.parse(JSON.stringify(this._decoratorArea)),canvas:this._cvsViewDecorator}}showViewDecorator(){this._cvsViewDecorator&&"none"==this._cvsViewDecorator.style.display&&(this._cvsViewDecorator.style.display="")}hideViewDecorator(){this._cvsViewDecorator&&(this._cvsViewDecorator.style.display="none")}setViewDecoratorLineWidth(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("lineWidth"))throw new Error(`It is not allowed to change the property 'lineWidth' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].lineWidth=t,this._updateViewDecorator()}setViewDecoratorStrokeStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("strokeStyle"))throw new Error(`It is not allowed to change the property 'strokeStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].strokeStyle=t,this._updateViewDecorator()}setViewDecoratorFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("fillStyle"))throw new Error(`It is not allowed to change the property 'fillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].fillStyle=t,this._updateViewDecorator()}setViewDecoratorMaskFillStyle(e,t){if("string"!=typeof e)throw new Error("The 'type' should be a string.");if(e=e.toLowerCase(),!this._viewDecoratorInfo.hasOwnProperty(e))throw new Error(`The type of '${e}' doesn't exist.`);if(!this._viewDecoratorInfo[e].hasOwnProperty("maskFillStyle"))throw new Error(`It is not allowed to change the property 'maskFillStyle' when the decorator type is '${e}'.`);this._viewDecoratorInfo[e].maskFillStyle=t,this._updateViewDecorator()}_updateViewDecorator(){if(!this._bOpen)return;if(!this._cvsViewDecorator||!this._decoratorArea)return;let e;if(this.singleFrameMode)e="contain";else{if(!this._video)return;e=this.getVideoFit()}const t=this._cvsViewDecorator;t.style.position="absolute",t.style.width="100%",t.style.height="100%",t.style.left="0",t.style.top="0",t.style.objectFit=e;const i=this.getVisibleRegion(!0),o=i.regionRight-i.regionLeft,r=i.regionBottom-i.regionTop;t.width==o&&t.height==r||(t.width=o,t.height=r);const s=t.getContext("2d");s.clearRect(0,0,t.width,t.height);const n=this._decoratorArea.x/100*o,a=this._decoratorArea.y/100*r,h=this._decoratorArea.width/100*o,l=this._decoratorArea.height/100*r;for(let e of this._decoratorType){if("rectangle"===e){s.fillStyle=this._viewDecoratorInfo.rectangle.maskFillStyle,s.fillRect(0,0,t.width,t.height),s.clearRect(Math.round(n),Math.round(a),Math.round(h),Math.round(l)),s.fillStyle=this._viewDecoratorInfo.rectangle.fillStyle,s.fillRect(Math.round(n),Math.round(a),Math.round(h),Math.round(l)),s.lineWidth=this._viewDecoratorInfo.rectangle.lineWidth,s.strokeStyle=this._viewDecoratorInfo.rectangle.strokeStyle;const e=s.lineWidth/2;s.strokeRect(Math.round(n-e),Math.round(a-e),Math.round(h+s.lineWidth),Math.round(l+s.lineWidth))}if("focus"===e){s.fillStyle=this._viewDecoratorInfo.focus.maskFillStyle,s.fillRect(0,0,t.width,t.height),s.clearRect(Math.round(n),Math.round(a),Math.round(h),Math.round(l)),s.fillStyle=this._viewDecoratorInfo.focus.fillStyle,s.fillRect(Math.round(n),Math.round(a),Math.round(h),Math.round(l)),s.lineWidth=this._viewDecoratorInfo.focus.lineWidth,s.strokeStyle=this._viewDecoratorInfo.focus.strokeStyle;const e=s.lineWidth/2,i=[0,.25,.75,1],o=[0,.25,.75,1];s.beginPath();for(let e=0;e<i.length;e++)if(0==e||3==e)for(let t=0;t<o.length;t+=2)s.moveTo(Math.round(n+i[e]*h),Math.round(a+o[t]*l)),s.lineTo(Math.round(n+i[e]*h),Math.round(a+o[t+1]*l));for(let t=0;t<o.length;t++)if(0==t||3==t)for(let r=0;r<i.length;r+=2)s.moveTo(Math.round(n+i[r]*h-e),Math.round(a+o[t]*l)),s.lineTo(Math.round(n+i[r+1]*h+e),Math.round(a+o[t]*l));s.stroke()}if("crossline"===e&&(s.beginPath(),s.lineWidth=this._viewDecoratorInfo.crossline.lineWidth,s.strokeStyle=this._viewDecoratorInfo.crossline.strokeStyle,s.moveTo(Math.round(n),Math.round(a+l/2)),s.lineTo(Math.round(n+h),Math.round(a+l/2)),s.moveTo(Math.round(n+h/2),Math.round(a)),s.lineTo(Math.round(n+h/2),Math.round(a+l)),s.stroke()),"crosshair"===e){s.beginPath();const e=.05*Math.min(h,l);s.lineWidth=this._viewDecoratorInfo.crosshair.lineWidth,s.strokeStyle=this._viewDecoratorInfo.crosshair.strokeStyle,s.moveTo(Math.round(n+(h-e)/2),Math.round(a+l/2)),s.lineTo(Math.round(n+(h+e)/2),Math.round(a+l/2)),s.moveTo(Math.round(n+h/2),Math.round(a+(l-e)/2)),s.lineTo(Math.round(n+h/2),Math.round(a+(l+e)/2)),s.stroke()}}}getVisibleRegion(e){let t,i,o;if(this._assertOpen(),this.singleFrameMode)t=this._imgWidth,i=this._imgHeight,o="contain";else{if(!this._video)return;t=this._video.videoWidth,i=this._video.videoHeight,o=this.getVideoFit()}let r=(()=>{const e=parseFloat(window.getComputedStyle(this._video).width),r=parseFloat(window.getComputedStyle(this._video).height);let s,n={regionBottom:i,regionRight:t,regionLeft:0,regionTop:0,regionMeasuredByPercentage:!1};return"cover"===o?e/r<t/i?(s=i/r,n.regionLeft=Math.floor((t-s*e)/2),n.regionRight=Math.ceil(t-n.regionLeft),n.regionTop=0,n.regionBottom=i):(s=t/e,n.regionTop=Math.floor((i-s*r)/2),n.regionBottom=Math.ceil(i-n.regionTop),n.regionLeft=0,n.regionRight=t):"none"===o&&(e<t&&r<i?(n.regionLeft=Math.floor((t-e)/2),n.regionRight=Math.ceil(t-n.regionLeft),n.regionTop=Math.floor((i-r)/2),n.regionBottom=Math.ceil(i-n.regionTop)):e<t?(n.regionLeft=Math.floor((t-e)/2),n.regionRight=Math.ceil(t-n.regionLeft),n.regionTop=0,n.regionBottom=i):r<i&&(n.regionTop=Math.floor((i-r)/2),n.regionBottom=Math.ceil(i-n.regionTop),n.regionLeft=0,n.regionRight=t)),n})();return e?r.regionMeasuredByPercentage=!1:(r.regionBottom=Math.ceil(r.regionBottom/i*100),r.regionRight=Math.ceil(r.regionRight/t*100),r.regionLeft=Math.floor(r.regionLeft/t*100),r.regionTop=Math.floor(r.regionTop/i*100),r.regionMeasuredByPercentage=!0),r}setScanRegionMaskStyle(e){e&&(e.fillStyle&&(this.regionMaskFillStyle=e.fillStyle),e.strokeStyle&&(this.regionMaskStrokeStyle=e.strokeStyle),e.lineWidth&&(this.regionMaskLineWidth=e.lineWidth),this._updateScanRegionCanvas())}_getRegionInPixels(e,t,i){if(!(e<=0||t<=0)){if(!i)return{regionLeft:0,regionTop:0,regionRight:e,regionBottom:t,regionMeasuredByPercentage:!1};if(i.regionMeasuredByPercentage)return{regionLeft:Math.round(i.regionLeft/100*e),regionTop:Math.round(i.regionTop/100*t),regionRight:Math.round(i.regionRight/100*e),regionBottom:Math.round(i.regionBottom/100*t),regionMeasuredByPercentage:!1};return JSON.parse(JSON.stringify(i))}}_updateScanRegionCanvas(){if(!this._bOpen)return;let e,t,i;if(this.singleFrameMode)e=this._imgWidth,t=this._imgHeight,i="contain";else{if(!this._video)return;e=this._video.videoWidth,t=this._video.videoHeight,i=this.getVideoFit()}if(e<=0||t<=0)return void(this._cvsScanRegion&&(this._cvsScanRegion.width=0,this._cvsScanRegion.height=0));const o=this._getRegionInPixels(e,t,this._scanRegion);if(!this._cvsScanRegion)if(this._cvsScanRegion=document.createElement("canvas"),this._cvsScanRegion.className="cvs-scan-region",this.singleFrameMode&&(this._cvsScanRegion.addEventListener("click",this._clickIptSingleFrameMode),this._cvsScanRegion.style.cursor="pointer",this._cvsScanRegion.setAttribute("title","Take a photo")),this._arrScanRegionOverlays&&0!=this._arrScanRegionOverlays.length){const e=this._arrScanRegionOverlays.length;this._arrScanRegionOverlays[e-1].after(this._cvsScanRegion)}else this._divScanArea?this._divScanArea.before(this._cvsScanRegion):this._cvsSingleFrameMode?this._cvsSingleFrameMode.after(this._cvsScanRegion):this._video.after(this._cvsScanRegion);const r=this._cvsScanRegion;r.style.position="absolute",r.style.width="100%",r.style.height="100%",r.style.left="0",r.style.top="0",r.style.objectFit=i,r.width==e&&r.height==t||(r.width=e,r.height=t);const s=r.getContext("2d");if(s.clearRect(0,0,r.width,r.height),0!=o.regionLeft||o.regionRight!=e||0!=o.regionTop||o.regionBottom!=t){const e=o.regionLeft,t=o.regionTop,i=o.regionRight-o.regionLeft,n=o.regionBottom-o.regionTop;s.fillStyle=this.regionMaskFillStyle,s.fillRect(0,0,r.width,r.height),s.clearRect(Math.round(e),Math.round(t),Math.round(i),Math.round(n)),s.strokeStyle=this.regionMaskStrokeStyle,s.lineWidth=this.regionMaskLineWidth;const a=s.lineWidth/2;s.strokeRect(Math.round(e-a),Math.round(t-a),Math.round(i+s.lineWidth),Math.round(n+s.lineWidth))}}_updateScanAreaDiv(){if(!this._bOpen)return;let e,t,i;if(this.singleFrameMode)e=this._imgWidth,t=this._imgHeight,i="contain";else{if(!this._video)return;e=this._video.videoWidth,t=this._video.videoHeight,i=this.getVideoFit()}if(!this._divScanArea)return;if(e<=0||t<=0)return this._divScanArea.style.width="0",void(this._divScanArea.style.height="0");const o=this._getRegionInPixels(e,t,this._scanRegion),r=window.getComputedStyle(this._video),s=parseFloat(r.width),n=parseFloat(r.height),a=s/n,h=e/t;let l,d,c,g,v=1;if("contain"===i)a<h?(v=s/e,l=0,d=(n-t*v)/2):(v=n/t,l=(s-e*v)/2,d=0),l+=o.regionLeft*v,d+=o.regionTop*v,c=(o.regionRight-o.regionLeft)*v,g=(o.regionBottom-o.regionTop)*v;else if("cover"===i)if(a<h){v=n/t,l=o.regionLeft*v-(e*v-s)/2,l=Math.max(l,0),l=Math.min(l,parseFloat(r.width)),d=o.regionTop*v;let i=o.regionRight*v-(e*v-s)/2;i=Math.max(i,0),i=Math.min(i,parseFloat(r.width)),c=i-l,g=(o.regionBottom-o.regionTop)*v}else{v=s/e,l=o.regionLeft*v,d=o.regionTop*v-(t*v-n)/2,d=Math.max(d,0),d=Math.min(d,parseFloat(r.height));let i=o.regionBottom*v-(t*v-n)/2;i=Math.max(i,0),i=Math.min(i,parseFloat(r.height)),c=(o.regionRight-o.regionLeft)*v,g=i-d}else l=0,d=0,c=0,g=0;this._divScanArea.style.left=l+"px",this._divScanArea.style.top=d+"px",this._divScanArea.style.width=c+"px",this._divScanArea.style.height=g+"px"}set croppingRegions(e){this._croppingRegions=e,this._bFetchingLoopStarted&&(this.bIncreaseRegionIndexAuto&&(this._croppingRegionIndex=0),this._fetchingLoop(!1))}get croppingRegions(){return this._croppingRegions}set croppingRegionIndex(e){if(!Number.isInteger(e))throw new Error("'croppingRegionIndex' should be a integer.");e<0?(this.bIncreaseRegionIndexAuto=!0,this._croppingRegionIndex=0):(this.bIncreaseRegionIndexAuto=!1,this._croppingRegionIndex=e)}get croppingRegionIndex(){return this._croppingRegionIndex}set loopInterval(e){if(e<0)throw new Error("'loopInterval' should be greater than or equal to 0.");this._loopInterval=e,this._bFetchingLoopStarted&&this._fetchingLoop(!1)}get loopInterval(){return this._loopInterval}set maxNumberOfFramesInBuffer(e){if(!Number.isInteger(e))throw new Error("The 'maxNumberOfFramesInBuffer' should be a integer.");if(e<=0)throw new Error("The 'loopInterval' should be greater than 0.");for(this._maxNumberOfFramesInBuffer=e;this._frameQueue&&this._frameQueue.length>this._maxNumberOfFramesInBuffer;)this._frameQueue.shift()}get maxNumberOfFramesInBuffer(){return this._maxNumberOfFramesInBuffer}get numberOfFramesInBuffer(){return this._frameQueue.length}isContextDestroyed(){return this.bDestroyed}static createInstance(e){return t(this,void 0,void 0,(function*(){if(i)throw new Error("`CameraEnhancer` is not supported in Node.js.");let t=new r;("string"==typeof e||e instanceof String)&&(e=JSON.parse(e));for(let i in e)t[i]=e[i];return yield t.setUIElement(r.defaultUIElementURL),this._hasEngineResourceLoaded=!0,t}))}play(e,i,o){return t(this,void 0,void 0,(function*(){if(this._video&&this.videoSrc){yield new Promise(((e,i)=>{this._video.onloadedmetadata=()=>t(this,void 0,void 0,(function*(){this._video&&(this._video.onloadedmetadata=null,yield this._video.play(),e())})),"string"==typeof this.videoSrc||this.videoSrc instanceof String?this._video.src=this.videoSrc:this._video.srcObject=this.videoSrc,setTimeout((()=>i(new Error("Failed to play video. Timeout."))),4e3)}));let e={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};const i=this.mapCameraEvents.get("played");for(let t of i){const i=JSON.parse(JSON.stringify(e));setTimeout((()=>t(i)),0)}return e}if(this.singleFrameMode)return this._clickIptSingleFrameMode(),{width:0,height:0,deviceId:null};if(!this._video)return null;const s=++this.iPlayRound;let n=null,a=0,h=0;if(this._currentCamera&&(n=this._currentCamera.deviceId),this._video&&(a=this._video.videoWidth,h=this._video.videoHeight),this.promisePlay&&(yield this.promisePlay,s<this.iPlayRound))return{width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};this.promisePlay=(()=>t(this,void 0,void 0,(function*(){var s;try{this._video&&this._video.srcObject&&this.stop(),r._onLog&&r._onLog("DCE: ======before video========");const l=()=>{if(!this._video)throw _&&_.getTracks().forEach((e=>{e.stop()})),this._videoTrack=null,this._currentCamera=null,new Error("'video' is null.")},d=this.getVideoSettings();let c;"boolean"==typeof d.video&&(d.video={});const g=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","后面","後面","背面","后置","後置","背置","задней","الخلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","takakamera","belakang","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक"],v=()=>{for(let e of this._allCameras){let t=e.label.toLowerCase();if(t&&g.some((e=>-1!=t.indexOf(e)))&&/\b0(\b)?/.test(t)){delete d.video.facingMode,d.video.deviceId={ideal:e.deviceId};break}}d.video.deviceId||-1==["Android","HarmonyOS"].indexOf(r.browserInfo.OS)||(delete d.video.facingMode,d.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})};if(e)delete d.video.facingMode,d.video.deviceId={exact:e};else if(d.video.deviceId);else if(this._lastDeviceId)delete d.video.facingMode,d.video.deviceId={exact:this._lastDeviceId};else if(this.ifSaveLastUsedCamera&&r.isStorageAvailable&&window.localStorage.getItem("dce_last_camera_id")){delete d.video.facingMode,d.video.deviceId={exact:window.localStorage.getItem("dce_last_camera_id")};const e=JSON.parse(window.localStorage.getItem("dce_last_apply_width")),t=JSON.parse(window.localStorage.getItem("dce_last_apply_height"));e&&t&&(d.video.width=e,d.video.height=t)}else if(this.ifSkipCameraInspection);else if(d.video.facingMode){if(yield this.getAllCameras(),!this._video)return null;let e=d.video.facingMode;e instanceof Array&&e.length&&(e=e[0]),e=e.exact||e.ideal||e,"environment"===e&&(c=!!d.video.facingMode,v())}let _;i&&(d.video.width={ideal:i}),o&&(d.video.height={ideal:o}),r._onLog&&r._onLog("DCE: ======try getUserMedia========");let u,m=[0,500],p=null,f=null;function S(e){return t(this,void 0,void 0,(function*(){for(let t of m){l(),t&&(yield new Promise((e=>setTimeout(e,t)))),l();{const t=e.video.deviceId;f=t?t.exact||t.ideal||t:null}try{r._onLog&&r._onLog("DCE: ask "+JSON.stringify(e)),_=yield navigator.mediaDevices.getUserMedia(e),l();break}catch(e){p=e,r._onLog&&r._onLog("DCE: "+e.message||e)}}}))}if(yield S(d),!_){if(r._onLog&&r._onLog("DCE: ======try getUserMedia again========"),u=JSON.parse(JSON.stringify(d)),"object"==typeof u.video){"iPhone"==r.browserInfo.OS?(i>=1280||o>=1280?u.video.width=1280:i>=640||o>=640?u.video.width=640:(i<640||o<640)&&(u.video.width=320),delete u.video.height):c&&!d.video.deviceId?(delete u.video.facingMode,this._allCameras.length&&(u.video.deviceId={ideal:this._allCameras[this._allCameras.length-1].deviceId})):u.video=!0}r._onLog&&r._onLog("DCE: "+u),yield S(u)}if(_||(m=[1e3,2e3],yield S(d)),_||(yield S(u)),!_)throw p;const y=()=>{const e=_.getVideoTracks();let t,i;if(e.length&&(t=this._videoTrack=e[0]),this._video&&t){const e=t.getSettings();if(e)for(let o of this._allCameras)if(e.deviceId===o.deviceId){o._checked=!0,o.label=t.label,i=o;break}if(!i&&f)for(let e of this._allCameras)if(f==e.deviceId){t.label&&(e._checked=!0,e.label=t.label),i=e;break}}this._currentCamera=i};if(yield this.getAllCameras(),l(),c){y(),v();let e=d.video.deviceId;e&&(e=e.exact||e.ideal||e);let t=null===(s=this._currentCamera)||void 0===s?void 0:s.deviceId;!e||t&&e==t||(_.getTracks().forEach((e=>{e.stop()})),m=[0,500,1e3,2e3],yield S(d))}l();const w=()=>t(this,void 0,void 0,(function*(){r._onLog&&r._onLog("======play video========"),yield new Promise(((e,i)=>{l(),this._video.onloadedmetadata=()=>t(this,void 0,void 0,(function*(){l(),this._video.onloadedmetadata=null,yield this._video.play(),e()})),this._video.srcObject=_,setTimeout((()=>i(new Error("Failed to play video. Timeout."))),4e3)}))}));yield w(),l(),r._onLog&&r._onLog("DCE: ======played video========"),this._bgLoading&&(this._bgLoading.style.animationPlayState="paused");const R=this._video.videoWidth+"x"+this._video.videoHeight;this._optGotRsl&&(this._optGotRsl.setAttribute("data-width",this._video.videoWidth),this._optGotRsl.setAttribute("data-height",this._video.videoHeight),this._optGotRsl.innerText=R,this._selRsl&&this._optGotRsl.parentNode==this._selRsl&&(this._selRsl.value="got")),r._onLog&&r._onLog("DCE: got "+R),y(),l(),this._renderSelCameraInfo();const b={width:this._video.videoWidth,height:this._video.videoHeight,deviceId:this._currentCamera&&this._currentCamera.deviceId};b.deviceId&&(this._lastDeviceId=b.deviceId,this.ifSaveLastUsedCamera&&r.isStorageAvailable&&(window.localStorage.setItem("dce_last_camera_id",this._lastDeviceId),d.video.width&&d.video.height&&(window.localStorage.setItem("dce_last_apply_width",JSON.stringify(d.video.width)),window.localStorage.setItem("dce_last_apply_height",JSON.stringify(d.video.height)))));const L=this.mapCameraEvents.get("played");for(let e of L){const t=JSON.parse(JSON.stringify(b));setTimeout((()=>e(t)),0)}if(n&&n!=b.deviceId){const e=this.mapCameraEvents.get("cameraChange");for(let t of e){const e=JSON.parse(JSON.stringify(b));setTimeout((()=>t(e)),0)}}if(a&&h&&(a!=b.width||h!=b.height)){this._updateScanRegionCanvas(),this._updateScanAreaDiv(),this._updateViewDecorator();for(let e of this._arrScanRegionOverlays)e&&this._updateScanRegionOverlay(e);const e=this.mapCameraEvents.get("resolutionChange");for(let t of e){const e=JSON.parse(JSON.stringify(b));setTimeout((()=>t(e)),0)}}return this.promisePlay=null,b}catch(e){throw this.promisePlay=null,e}})))();return yield this.promisePlay}))}resume(){return t(this,void 0,void 0,(function*(){this._assertOpen(),yield this.play(),this._bStoppedByPause&&(this._bStoppedByPause=!1,this.startFetchingLoop())}))}pause(){this._bOpen||console.warn("The camera is not open."),this._video&&this._video.pause(),this._bFetchingLoopStarted&&(this.stopFetchingLoop(),this._bStoppedByPause=!0)}close(e){if(!this._video)return;this.stop(),this._unbindUI(),e&&(this.UIElement.style.display="none"),this.stopFetchingLoop(),this.bOpen=!1;const t=this.mapCameraEvents.get("cameraClose");for(let e of t){const t={width:0,height:0,deviceId:null};setTimeout((()=>e(t)),0)}}open(e){return t(this,void 0,void 0,(function*(){this._bindUI(),e&&(this.UIElement.parentNode||(this.UIElement.style.position="fixed",this.UIElement.style.left="0",this.UIElement.style.top="0",document.body.append(this.UIElement)),"none"==this.UIElement.style.display&&(this.UIElement.style.display=""));let t=yield this.play();this.bOpen=!0;const i=this.mapCameraEvents.get("cameraOpen");for(let e of i){const i=JSON.parse(JSON.stringify(t));setTimeout((()=>e(i)),0)}return t}))}stop(){this._video&&this._video.srcObject&&(r._onLog&&r._onLog("DCE: ======stop video========"),this._video.srcObject.getTracks().forEach((e=>{e.stop()})),this._video.srcObject=null,this._videoTrack=null,this._currentCamera=null),this._video&&this._video.classList.contains("dce-existingVideo")&&(r._onLog&&r._onLog("DCE: ======stop existing video========"),this._video.pause(),this._video.currentTime=0),this._bgLoading&&(this._bgLoading.style.animationPlayState=""),this._frameQueue.length=0}getAllCameras(){return t(this,void 0,void 0,(function*(){const e=yield navigator.mediaDevices.enumerateDevices(),t=[],i=[];if(this._allCameras)for(let e of this._allCameras)e._checked&&i.push(e);for(let o=0;o<e.length;o++){let r,s=e[o];if("videoinput"==s.kind){for(let e of i)s.deviceId==e.deviceId&&(r=e);r||(r={},r.deviceId=s.deviceId,r.label=s.label?s.label:"camera "+o),t.push(r)}}return this._allCameras=t,r._onLog&&r._onLog("DCE: "+JSON.stringify(this._allCameras)),Promise.resolve(t)}))}_renderSelCameraInfo(){if(this._selCam&&(this._selCam.innerHTML=""),this._selCam){let e;for(let t of this._allCameras){let i=document.createElement("option");i.value=t.deviceId,i.innerText=t.label,this._selCam.append(i),t.deviceId&&this._currentCamera&&this._currentCamera.deviceId==t.deviceId&&(e=i)}this._selCam.value=e?e.value:""}}getSelectedCamera(){return this._currentCamera}selectCamera(e){return t(this,void 0,void 0,(function*(){return yield this.play(e.deviceId||e)}))}getResolution(){return this._bOpen?[this._video.videoWidth,this._video.videoHeight]:null}setResolution(e,i){return t(this,void 0,void 0,(function*(){let t,o;if(this._bOpen){e instanceof Array?(t=e[0],o=e[1]):(t=e,o=i);return yield this.play(null,t,o)}return yield Promise.reject(new Error("The camera is not open."))}))}on(e,t){if(!this.mapCameraEvents.has(e))throw new Error(`Event '${e}' is not exists.`);const i=this.mapCameraEvents.get(e);i.includes(t)||i.push(t)}off(e,t){if(!this.mapCameraEvents.has(e))throw new Error(`Event '${e}' is not exists.`);const i=this.mapCameraEvents.get(e),o=i.indexOf(t);-1!==o&&i.splice(o,1)}getVideoSettings(){return JSON.parse(JSON.stringify(this.videoSettings))}updateVideoSettings(e){return this.videoSettings=JSON.parse(JSON.stringify(e)),this._lastDeviceId=null,this._bOpen?this.play():Promise.resolve()}isOpen(){return this._bOpen}getCapabilities(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');return this._videoTrack.getCapabilities?this._videoTrack.getCapabilities():{}}getCameraSettings(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getCameraSettings()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');return this._videoTrack.getSettings()}getConstraints(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'getConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');return this._videoTrack.getConstraints()}applyConstraints(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'applyConstraints()' is unavailable in singleFrameMode.");if(!this._videoTrack)throw new Error('"_videoTrack" is null.');if(!this._videoTrack.applyConstraints)throw Error("Not supported.");return yield this._videoTrack.applyConstraints(e)}))}turnOnTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOnTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!0}]});throw Error("Not supported.")}))}turnOffTorch(){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'turnOffTorch()' is unavailable in singleFrameMode.");if(this.getCapabilities().torch)return yield this._videoTrack.applyConstraints({advanced:[{torch:!1}]});throw Error("Not supported.")}))}setColorTemperature(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setColorTemperature()' is unavailable in singleFrameMode.");let t=this.getCapabilities().colorTemperature;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{colorTemperature:e}]})}))}setExposureCompensation(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setExposureCompensation()' is unavailable in singleFrameMode.");let t=this.getCapabilities().exposureCompensation;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{exposureCompensation:e}]})}))}setZoom(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setZoom()' is unavailable in singleFrameMode.");let t=this.getCapabilities().zoom;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({advanced:[{zoom:e}]})}))}setFrameRate(e){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFrameRate()' is unavailable in singleFrameMode.");let t=this.getCapabilities().frameRate;if(!t)throw Error("Not supported.");return e<t.min?e=t.min:e>t.max&&(e=t.max),yield this._videoTrack.applyConstraints({width:{ideal:Math.max(this._video.videoWidth,this._video.videoHeight)},frameRate:e})}))}getFrameRate(){return this.getCameraSettings().frameRate}setFocus(e,i){return t(this,void 0,void 0,(function*(){if(this._assertOpen(),this.singleFrameMode)throw new Error("'setFocus()' is unavailable in singleFrameMode.");const t=this.getCapabilities().focusMode,o=this.getCapabilities().focusDistance;if(!t||!t.includes(e)||!o)throw Error("Not supported.");return i?(i<o.min?i=o.min:i>o.max&&(i=o.max),yield this._videoTrack.applyConstraints({advanced:[{focusMode:e,focusDistance:i}]})):yield this._videoTrack.applyConstraints({advanced:[{focusMode:e}]})}))}getFocus(){const e=this.getCameraSettings().focusMode;return"continuous"===e?{mode:e}:{mode:e,distance:this.getCameraSettings().focusDistance}}getFrame(){if(this.singleFrameMode)throw Error("'getFrame()' is unavailable in singleFrameMode.");return this._getFrame(this._scanRegion)}_getFrame(e){if(this.bDestroyed)throw Error("The DCE instance has been destroyed.");if(this._assertOpen(),this.singleFrameMode)throw new Error("'_getFrame()' is unavailable in singleFrameMode.");r._onLog&&r._onLog("DCE: _getFrame(region?)");const t=Date.now(),i=this._video.videoWidth,o=this._video.videoHeight;let s,n,a,h,l,d,c=i,g=o,v={regionLeft:0,regionTop:0,regionRight:c,regionBottom:g,regionMeasuredByPercentage:!1};e?(e.regionMeasuredByPercentage?(v.regionLeft=e.regionLeft*c/100,v.regionTop=e.regionTop*g/100,v.regionRight=e.regionRight*c/100,v.regionBottom=e.regionBottom*g/100):(v.regionLeft=e.regionLeft,v.regionTop=e.regionTop,v.regionRight=e.regionRight,v.regionBottom=e.regionBottom),s=v.regionLeft,n=v.regionTop,c=Math.round(v.regionRight-v.regionLeft),g=Math.round(v.regionBottom-v.regionTop),l=!0):(s=0,n=0,l=!1);const _=Math.max(c,g);if(_>this._maxCvsSideLength&&this._maxCvsSideLength>0){const e=this._maxCvsSideLength/_;c>g?(a=this._maxCvsSideLength,h=Math.round(g*e)):(a=Math.round(c*e),h=this._maxCvsSideLength),d=!0}else a=c,h=g,d=!1;if((()=>!(this.bSaveOriCanvas||!this._bWebGLSupported||d))()){this.videoGlCvs||(this.videoGlCvs=document.createElement("canvas"));const d=this.videoGlCvs;d.width==i&&d.height==o||(d.width=i,d.height=o,this.videoGl&&this.videoGl.viewport(0,0,i,o));const _=this.videoGl||d.getContext("webgl",{alpha:!1,antialias:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!0})||d.getContext("experimental-webgl",{alpha:!1,antialias:!1,depth:!1,stencil:!1,preserveDrawingBuffer:!0});if(!_)return this.videoGl=null,this._bWebGLSupported=!1,this._getFrame(e);_.enable(_.SCISSOR_TEST);const u=s,m=o-v.regionBottom;if(_.scissor(u,m,a,h),!this.videoGl){this.videoGl=_;const e=e=>{const t=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,t);e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,1,1,-1,1]),e.STATIC_DRAW);const i=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i);return e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),e.STATIC_DRAW),{position:t,indices:i}},t=e=>{const t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),t},i=(e,t,i)=>{const r=o(e,e.VERTEX_SHADER,t),s=o(e,e.FRAGMENT_SHADER,i),n=e.createProgram();return e.attachShader(n,r),e.attachShader(n,s),e.linkProgram(n),e.getProgramParameter(n,e.LINK_STATUS)?n:(alert("Unable to initialize the shader program: "+e.getProgramInfoLog(n)),null)},o=(e,t,i)=>{const o=e.createShader(t);return e.shaderSource(o,i),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(o)),e.deleteShader(o),null)},r=i(_,"\n                  attribute mediump vec2 aVertexPosition;\n                  varying mediump vec2 vDirection;\n          \n                  void main( void )\n                  {\n                      gl_Position = vec4(aVertexPosition, 1.0, 1.0) * 2.0;\n                      vDirection = aVertexPosition;\n                  }\n                ","\n                    precision mediump float;\n\n                    varying mediump vec2 vDirection;\n                    uniform sampler2D uSampler;\n                    uniform lowp float uColorFactor;\n            \n                    void main(void)\n                    {\n                        vec4 sample = texture2D(uSampler, vec2(vDirection.x * 0.5 + 0.5, vDirection.y * 0.5 + 0.5));\n                        lowp float grey = 0.21 * sample.r + 0.71 * sample.g + 0.07 * sample.b;\n                        gl_FragColor = vec4(sample.rgb * (1.0 - uColorFactor) + (grey * uColorFactor), sample.a);\n                    }\n                ");this.webglProgramInfo={program:r,attribLocations:{vertexPosition:_.getAttribLocation(r,"aVertexPosition")},uniformLocations:{uSampler:_.getUniformLocation(r,"uSampler"),uColorFactor:_.getUniformLocation(r,"uColorFactor")}},this.webglBuffers=e(_),this.webglTexture=t(_)}const p=(e,t,i)=>{const o=e.RGBA,r=e.RGBA,s=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,o,r,s,i)},f=(e,t,i,o)=>{e.clearColor(0,0,0,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);{const o=2,r=e.FLOAT,s=!1,n=0,a=0;e.bindBuffer(e.ARRAY_BUFFER,i.position),e.vertexAttribPointer(t.attribLocations.vertexPosition,o,r,s,n,a),e.enableVertexAttribArray(t.attribLocations.vertexPosition)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.indices),e.useProgram(t.program),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(t.uniformLocations.uSampler,0),e.uniform1f(t.uniformLocations.uColorFactor,1);const r=e.UNSIGNED_SHORT;e.drawElements(e.TRIANGLES,6,r,0)};p(_,this.webglTexture,this._video),f(_,this.webglProgramInfo,this.webglBuffers,this.webglTexture),(!this.glImgData||this.glImgData.length<a*h*4)&&(this.glImgData=new Uint8Array(a*h*4));const S=this.glImgData;_.readPixels(u,m,a,h,_.RGBA,_.UNSIGNED_BYTE,S),_.disable(_.SCISSOR_TEST);let y=r._onLog?Date.now():0,w=new Uint8Array(new Uint32Array(S.buffer));r._onLog&&r._onLog("DCE: Extract grey cost: "+(Date.now()-y));const R=Date.now();return{canvas:null,data:w,region:e?JSON.parse(JSON.stringify(e)):null,sx:s,sy:n,width:c,height:g,timeSpent:R-t,timeStamp:R,isCropped:l}}{let i=null;if(this.bSaveOriCanvas)i=document.createElement("canvas"),i.width=a,i.height=h,i.ctx2d=i.getContext("2d");else{for(let e of this.videoCvses)if(e.width==a&&e.height==h){i=e;break}i||(i=document.createElement("canvas"),i.width=a,i.height=h,i.ctx2d=i.getContext("2d"),this.videoCvses.length>=this.maxVideoCvsLength&&(this.videoCvses=this.videoCvses.slice(1)),this.videoCvses.push(i))}const o=i.ctx2d;let r;o.drawImage(this._video,s,n,c,g,0,0,a,h),r=0===i.width||0===i.height?null:o.getImageData(0,0,i.width,i.height).data;const d=Date.now();return{data:r,canvas:i,region:e?JSON.parse(JSON.stringify(e)):null,sx:s,sy:n,width:c,height:g,timeSpent:d-t,timeStamp:d,isCropped:l}}}getCurrentRegion(){let e=null;if(this._scanRegion)e=this._scanRegion;else if(this._croppingRegions){if(this._croppingRegionIndex>=this._croppingRegions.length||this._croppingRegionIndex<0)throw new Error("The 'croppingRegionIndex' is out of bounds.");e=this._croppingRegions[this._croppingRegionIndex],this.bIncreaseRegionIndexAuto&&++this._croppingRegionIndex>=this._croppingRegions.length&&(this._croppingRegionIndex=0)}return e}_fetchingLoop(e){if(this.bDestroyed)return void this.stopFetchingLoop();if(!this._bOpen||!this.isFetchingLoopStarted())return void this.stopFetchingLoop();if(this._video.paused)return r._onLog&&r._onLog("DCE: Video is paused. Ask in 1s."),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),void(this._frameLoopTimeoutId=setTimeout((()=>{this._fetchingLoop(!0)}),1e3));const t=()=>{r._onLog&&r._onLog("DCE: start fetching a frame: "+Date.now());const e=this.getCurrentRegion();let t=this._getFrame(e);this._frameQueue&&this._frameQueue.length>=this._maxNumberOfFramesInBuffer&&this._frameQueue.shift(),this._frameQueue.push(t),r._onLog&&r._onLog("DCE: finish fetching a frame: "+Date.now())},i=()=>{this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this.refreshInterval<=0||(this._frameLoopTimeoutId2=setTimeout((()=>{this.bDestroyed?this.stopFetchingLoop():this._bOpen&&this.isFetchingLoopStarted()?this._video.paused?this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId):(r._onLog&&r._onLog("DCE: second timeout executes: "+Date.now()),t(),i()):this.stopFetchingLoop()}),this.refreshInterval))};e&&(this._frameQueue.length<this._maxNumberOfFramesInBuffer?(t(),this.refreshInterval>0&&i()):this.refreshInterval>0?(t(),i()):0===this.refreshInterval?t():this.refreshInterval),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameLoopTimeoutId=setTimeout((()=>{this._fetchingLoop(!0)}),this._loopInterval)}startFetchingLoop(){if(this.bDestroyed)throw Error("The DCE instance has been destroyed.");if(this._assertOpen(),this.singleFrameMode)throw Error("'startFetchingLoop()' is unavailable in singleFrameMode.");if(this._video.paused)throw Error("The video is paused.");this.isFetchingLoopStarted()||(this._bFetchingLoopStarted=!0,r._onLog&&r._onLog("start fetching loop: "+Date.now()),this._fetchingLoop(!0))}isFetchingLoopStarted(){return this._bFetchingLoopStarted}stopFetchingLoop(){this._bFetchingLoopStarted&&(r._onLog&&r._onLog("stop fetching loop: "+Date.now()),this._frameLoopTimeoutId&&clearTimeout(this._frameLoopTimeoutId),this._frameQueue.length=0,this._bFetchingLoopStarted=!1)}getFrameFromBuffer(e){return this._frameQueue&&this._frameQueue.length?e?e<this._frameQueue.length?(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.splice(e,1)[0]):void 0:(this._frameLoopTimeoutId2&&clearTimeout(this._frameLoopTimeoutId2),this._frameQueue.shift()):null}forceLoseContext(){if(!this.videoGl)return;const e=this.videoGl;e&&!e.isContextLost()&&e.getExtension("WEBGL_lose_context")&&e.getExtension("WEBGL_lose_context").loseContext(),this.webglTexture=null,this.webglProgramInfo=null,this.webglBuffers=null,this.videoGl=null,this.videoGlCvs=null}dispose(e){this.close(!0),this.forceLoseContext(),this.setViewDecorator(null,null);for(let e of this._arrScanRegionOverlays)e&&e.remove();e&&this.UIElement&&this.UIElement.remove(),this.__proto__=null}}r._jsVersion="2.1.0",r._jsEditVersion="20220119",r._version="JS "+r._jsVersion+"."+r._jsEditVersion,r.browserInfo=function(){if(!i&&!o){var e={init:function(){this.browser=this.searchString(this.dataBrowser)||"unknownBrowser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"unknownVersion",this.OS=this.searchString(this.dataOS)||"unknownOS","Linux"==this.OS&&-1!=navigator.userAgent.indexOf("Windows NT")&&(this.OS="HarmonyOS")},searchString:function(e){for(var t=0;t<e.length;t++){var i=e[t].string,o=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,i){if(-1!=i.indexOf(e[t].subString))return e[t].identity}else if(o)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(-1!=t)return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Edge",identity:"Edge"},{string:navigator.userAgent,subString:"OPR",identity:"OPR"},{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"}],dataOS:[{string:navigator.userAgent,subString:"HarmonyOS",identity:"HarmonyOS"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};return e.init(),{browser:e.browser,version:e.version,OS:e.OS}}if(o)return{browser:"ssr",version:0,OS:"ssr"}}(),r._hasEngineResourceLoaded=!1,r._engineResourcePath=(()=>{if(i)return"";if(!o&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),r._defaultUIElementURL="@engineResourcePath/dce.ui.html",e.CameraEnhancer=r,Object.defineProperty(e,"__esModule",{value:!0})}));
